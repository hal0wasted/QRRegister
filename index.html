<!DOCTYPE html>
<html ng-app="registerModule">
<head>
    <title>QR Register</title>
    <script type="text/javascript" src="https://code.angularjs.org/1.2.17/angular.min.js"></script>
    <script type="text/javascript" src="https://cdn.rawgit.com/nikunjness/QRRegister/master/qrregister/libs/angular.simplecouch.js"></script>
    <script type="text/javascript" src="https://cdn.rawgit.com/nikunjness/QRRegister/master/qrregister/libs/qrcode.js"></script>
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet">
    </head>
<body ng-controller="registerController" ng-init="initApp()">
<div  align="center" class="row">
    <img src="https://cdn.rawgit.com/nikunjness/QRRegister/master/qrregister/img/17800.jpg" height="150">
</div>
<div class="container" ng-hide="masterpanel">
    <div class="well">
        <div ng-show="errorWhileSubmit" class='alert alert-danger'>{{ errorWhileSubmit }}</div>
        <div ng-show="successWhileSubmit" class='alert alert-success'>{{ successWhileSubmit }}</div>
        <form class="form-horizontal" role="form" ng-submit="save()">
            <div class="form-group">
                <label class="col-sm-2 control-label">Name</label>
                <div class="col-sm-10">
                    <input type="text" class="form-control" ng-model="Attendee.name" required placeholder="Name">
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-2 control-label">Contact</label>
                <div class="col-sm-10">
                    <input type="tel" class="form-control" ng-model="Attendee.contact" required placeholder="Contact">
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-2 control-label">Email</label>
                <div class="col-sm-10">
                    <input type="email" class="form-control" ng-model="Attendee.email" required placeholder="Email">
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-2 control-label">Linkedin</label>
                <div class="col-sm-10">
                    <input type="url" class="form-control" ng-model="Attendee.linkedin" pattern="(?:http[s]?://|www|[linkedin]+)+\.[^\']+" placeholder="your linkedin profile url">
                </div>
            </div>
            <div class="form-group">
                <div class="col-sm-offset-2 col-sm-10">
                    <button type="submit" class="btn btn-default">Register</button>
                </div>
            </div>
        </form>


    </div>
</div>
<div class="container" ng-show="masterpanel">
    <div class="well">
        <table class="table table-condensed table-hover" ng-show="all_docs">
            <thead>
            <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Linkedin</th>
                <th>isPresent</th>
            </tr>
            </thead>
            <tbody>
            <tr ng-repeat="candidate in all_docs.rows">
                <td>{{ candidate.value.name }}</td>
                <td>{{ candidate.value.email }}</td>
                <td>{{ candidate.value.contact }}</td>
                <td> <a href="{{ candidate.value.linkedin }}" target="_blank">
                    {{ candidate.value.linkedin }} </a> </td>
                <td>{{ candidate.value.ispresent }}</td>
            </tr>
            </tbody>
        </table>
    </div>
</div>
<div id="ticket" class="container" hidden="true">
    <table>
        <tr>
            <td colspan="2" align="center"><h4> Google I/O Extended Ahmedabad </h4></td>
        </tr>
        <tr>
            <td colspan="2" align="center"><h5>Entry Ticket</h5></td>
        </tr>
        <tr>
            <td align="left"> {{ Attendee.name }} </td>
            <td align="right"> <div id="qrcode"></div> </td>
        </tr>
        <tr>
            <td colspan="2" align="left">
                Venue : <b>Ishi Systems</b> <br />
                A 6/7, 6th Floor, <br />Safal Profitaire, <br />Near Auda Garden, <br />Prahlad Nagar Corp Road,<br />
                Opp Ramada Hotel, <br />Ahmedabad
            </td>
        </tr>
    </table>
</div>
</body>
<script type="text/javascript">
    var registerModule = angular.module('registerModule', ['SimpleCouch']);
    var config = angular.module('Config', ['SimpleCouch']).config(function (couchConfigProvider,$httpProvider) {
        couchConfigProvider.setServer('http://127.0.0.1:5984');
        couchConfigProvider.setDB('dbname');

    });
    function registerController($scope, $http, $location,  couchdb) {
        $scope.Attendee = {};
        $scope.couchdb = couchdb;
        $scope.variable = '';
        $scope.errorWhileSubmit = null;
        $scope.successWhileSubmit = null;
        $scope.couchdb.config.setServer('http://localhost:5984');
        $scope.couchdb.config.setMethod('method GET/JSONP')
        $scope.couchdb.db.use('qrregister');
        $scope.all_docs = {}
        $scope.masterpanel=false

        var parameters = $location.search();
        console.log(parameters)
        if (parameters.admin) {
            $scope.masterpanel = true;
        } else {
            $scope.masterpanel = false;
        }
        $scope.getalldocs = function()
        {
            $http.get("http://localhost:5984/qrregister/_design/attendee/_view/all").success(function(data){
                console.log(data);
                $scope.all_docs = data;
            }).error(function(data){console.log("Error"+data);});
        }

        var create_qrcode = function(text, typeNumber, errorCorrectLevel, table) {

            var qr = qrcode(typeNumber || 6, errorCorrectLevel || 'M');
            qr.addData(text);
            qr.make();

            //	return qr.createTableTag();
            return qr.createImgTag();
        };
        $scope.save = function()
        {
            $scope.Attendee._id = $scope.Attendee.email
            $scope.Attendee.type='Attendee'
            $scope.Attendee.ispresent= "false"
            $scope.couchdb.doc.post($scope.Attendee,
                    function(data){
                        $scope.successWhileSubmit = "Data Added Successfully";
                        $scope.qrURL= "http://localhost:5984/qrregister/_design/attendee/_update/mark/"+$scope.Attendee._id
                        var d = document.getElementById('qrcode');
                        d.innerHTML = create_qrcode($scope.qrURL)
                        var data = d.childNodes[0].src
                        data.replace('data:image/gif;base64,','');
                        var email = {}
                        email.email = $scope.Attendee.email
                        email.data = data
                        email.printedTicket= document.getElementById('ticket').innerHTML.toString()
                        $http({
                            method: 'PUT',
                            url: '/_sendmail/',
                            data : TransformRequest(email),
                            headers: {'Content-Type': 'application/x-www-form-urlencoded'}
                        }).success(function (data) {
                            console.log(data);
                        }).error(function (data) {
                            console.log(data);
                        });
                        $scope.Attendee = {};
                        window.setTimeout(function () {
                            $scope.$apply(
                                    function () {
                                        $scope.successWhileSubmit = null;
                                    }
                            )
                        }, 5000);
                    },
                    function(data){
                        if(data.error=="conflict")
                            $scope.errorWhileSubmit = "You are already registered. Please check your email for ticket. :) ";
                        else
                            $scope.errorWhileSubmit = data.reason
                        $scope.Attendee = {};
                        window.setTimeout(function () {
                            $scope.$apply(
                                    function () {
                                        $scope.errorWhileSubmit = null;
                                    }
                            )
                        }, 5000);
                    });
        }

        var TransformRequest = function (data) {
            /**
             * The workhorse; converts an object to x-www-form-urlencoded serialization.
             * @param {Object} obj
             * @return {String}
             */

            var param = function (obj) {
                var query = '';
                var name, value, fullSubName, subName, subValue, innerObj, i;
                for (name in obj) {
                    console.log("Name :" + name);
                    value = obj[name];

                    if (value instanceof Array) {
                        for (i = 0; i < value.length; ++i) {
                            subValue = value[i];
                            fullSubName = name + '[' + i + ']';
                            innerObj = {};
                            innerObj[fullSubName] = subValue;
                            query += param(innerObj) + '&';
                        }
                    }
                    else if (value instanceof Object) {
                        for (subName in value) {
                            subValue = value[subName];
                            fullSubName = name + '[' + subName + ']';
                            innerObj = {};
                            innerObj[fullSubName] = subValue;
                            query += param(innerObj) + '&';
                        }
                    }
                    else if (value !== undefined && value !== null) {
                        query += encodeURIComponent(name) + '=' + encodeURIComponent(value) + '&';
                    }
                }
                console.log("Parameter Data : " + query);
                return query.length ? query.substr(0, query.length - 1) : query;
            };

            return angular.isObject(data) && String(data) !== '[object File]' ? param(data) : data;
        }

        $scope.initApp = function(){
            var searchview= {
                '_id': '_design/attendee',
                'language': 'javascript',
                'views': {
                    'all': {
                        'map': (function (doc) {
                            if (doc.type == 'Attendee') {
                                emit(doc.type, doc);
                            }
                        }).toString()
                    }
                },
                'updates': {
                    'mark': (function(doc, req) {
                        if (!doc){
                            return [null, {'code': 400,
                                'json': {'error': 'missed',
                                    'reason': 'no document to update'}}]
                        } else {
                            doc.ispresent = 'true';
                            return [doc, {'json': {'status': 'ok'}}];
                        }
                    }).toString()
                }

            };
            $scope.couchdb.doc.post(searchview,
                    function(data){
                        $scope.successWhileSubmit = "App initialized successfully";
                        window.setTimeout(function () {
                            $scope.$apply(
                                    function () {
                                        $scope.successWhileSubmit = null;
                                    }
                            )
                        }, 5000);
                    },
                    function(data){
                        $scope.errorWhileSubmit = "";
                        window.setTimeout(function () {
                            $scope.$apply(
                                    function () {
                                        $scope.errorWhileSubmit = null;
                                    }
                            )
                        }, 5000);
                    });
            $scope.getalldocs();
        }
    };
    registerModule.controller('registerController' , registerController);
</script>
</html>